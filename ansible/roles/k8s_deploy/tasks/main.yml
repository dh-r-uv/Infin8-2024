---
- name: Apply MySQL and App Deployment
  ansible.builtin.shell: kubectl apply -f k8s/deployment.yaml
  args:
    chdir: "{{ playbook_dir }}/.."

- name: Apply Canary Deployment (10-20% Traffic)
  ansible.builtin.shell: kubectl apply -f k8s/canary.yaml
  args:
    chdir: "{{ playbook_dir }}/.."

- name: Apply Horizontal Pod Autoscaler
  ansible.builtin.shell: kubectl apply -f k8s/hpa.yaml
  args:
    chdir: "{{ playbook_dir }}/.."

- name: Deploy ELK Stack (Elasticsearch, Logstash, Kibana, Metricbeat)
  ansible.builtin.shell: kubectl apply -f k8s/elk-stack.yaml
  args:
    chdir: "{{ playbook_dir }}/.."

- name: Apply Ingress Rules
  ansible.builtin.shell: kubectl apply -f k8s/ingress.yaml
  args:
    chdir: "{{ playbook_dir }}/.."

- name: Force Rollout Restart (Ensure Image Pull)
  ansible.builtin.shell: |
    kubectl rollout restart deployment/infin8-app
    kubectl rollout restart deployment/infin8-canary

- name: Wait for Deployment Rollout (with timeout)
  ansible.builtin.shell: kubectl rollout status deployment/infin8-app --timeout=3m
  register: rollout_status
  changed_when: false
  failed_when: false  # Don't fail if timeout - new pods might already be running
  ignore_errors: true

- name: Show Rollout Status
  debug:
    msg: "{{ rollout_status.stdout }}"
