input {
  # Django application logs via TCP
  tcp {
    port => 5000
    codec => json_lines
    type => "django"
  }

  # File input for backup/debugging
  file {
    path => "/usr/share/logstash/logs/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    type => "file"
  }
}

filter {
  # Add timestamp if missing
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }

  # Parse Django log levels
  if [level] {
    mutate {
      uppercase => [ "level" ]
    }
  }

  # Convert status codes to integers
  if [status_code] {
    mutate {
      convert => { "status_code" => "integer" }
    }
  }

  # Add environment context
  mutate {
    add_field => {
      "environment" => "development"
      "application" => "infin8"
    }
  }

  # Tag error logs for alerting
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_tag => [ "error", "alert" ]
    }
  }

  # Tag canary deployment logs
  if [type] == "canary" {
    mutate {
      add_tag => [ "canary", "deployment" ]
    }
  }
}

output {
  # Elasticsearch output with type-based daily indices
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "infin8-%{[type]}-%{+YYYY.MM.dd}"
  }

  # Debug output for development (can remove in production)
  stdout {
    codec => rubydebug
  }
}
